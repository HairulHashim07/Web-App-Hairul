<!DOCTYPE html>
<html>
<head>
    <title>three.js css3d - periodic table</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link type="text/css" rel="stylesheet" href="main.css">
</head>
<body>

<div id="info"><a href="https://threejs.org" target="_blank" rel="noopener">three.js</a> css3d - periodic table.</div>
<div id="container"></div>
<div id="menu">
    <button id="table">TABLE</button>
    <button id="sphere">SPHERE</button>
    <button id="helix">HELIX</button>
    <button id="grid">GRID</button>
</div>

<script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.module.js';
    import { TWEEN } from 'https://cdnjs.cloudflare.com/ajax/libs/tween.js/20.0.0/tween.umd.js';
    import { TrackballControls } from 'https://cdn.jsdelivr.net/npm/three@0.134.0/examples/jsm/controls/TrackballControls.js';
    import { CSS3DRenderer, CSS3DObject } from 'https://cdn.jsdelivr.net/npm/three@0.134.0/examples/jsm/renderers/CSS3DRenderer.js';
    
    let camera, scene, renderer;
    let controls;

    const objects = [];
    const targets = { table: [], sphere: [], helix: [], grid: [] };

    init();
    animate();

    function init() {
        camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 1, 10000);
        camera.position.z = 3000;

        scene = new THREE.Scene();

        // Load data from Google Sheets
        fetchGoogleSheetData().then(data => {
            if (data) {
                console.log('Data fetched successfully:', data);
                createTableObjects(data);
                transform(targets.table, 2000); // Show table initially
            } else {
                console.error('No data fetched from Google Sheets.');
            }
        }).catch(error => {
            console.error('Error fetching data from Google Sheets:', error);
        });

        // Renderer setup
        renderer = new CSS3DRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('container').appendChild(renderer.domElement);

        // Controls setup
        controls = new TrackballControls(camera, renderer.domElement);
        controls.minDistance = 500;
        controls.maxDistance = 6000;
        controls.addEventListener('change', render);

        // Menu button event listeners
        document.getElementById('table').addEventListener('click', () => transform(targets.table, 2000));
        document.getElementById('sphere').addEventListener('click', () => transform(targets.sphere, 2000));
        document.getElementById('helix').addEventListener('click', () => transform(targets.helix, 2000));
        document.getElementById('grid').addEventListener('click', () => transform(targets.grid, 2000));

        window.addEventListener('resize', onWindowResize);
    }

    async function fetchGoogleSheetData() {
        const sheetId = '1fsjeGyYwvsPz1M6I3ppuPb5d2Qx7eFdLMIQvJ6tWq90';
        const apiKey = 'AIzaSyCXVXtfzQbZxJnbZ99O8YQ244mDs4Y7bFk'; // Replace with your Google API key
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/Sheet1!A1:F201?key=${apiKey}`;

        try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Failed to fetch data: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();
                return data.values;
            } catch (error) {
                console.error('Error fetching Google Sheet data:', error);
                return null; // Or handle the error in another way based on your application's needs
            }
    }

    function createTableObjects(data) {
        for (let i = 0; i < data.length; i++) {
            const element = document.createElement('div');
            element.className = 'element';
            element.style.backgroundColor = `rgba(0,127,127,${Math.random() * 0.5 + 0.25})`;

            const number = document.createElement('div');
            number.className = 'number';
            number.textContent = i + 1;
            element.appendChild(number);

            const symbol = document.createElement('div');
            symbol.className = 'symbol';
            symbol.textContent = data[i][0]; // Symbol from Google Sheet
            element.appendChild(symbol);

            const details = document.createElement('div');
            details.className = 'details';
            details.innerHTML = `${data[i][1]}<br>${data[i][2]}`; // Name and weight from Google Sheet
            element.appendChild(details);

            const objectCSS = new CSS3DObject(element);
            objectCSS.position.x = Math.random() * 4000 - 2000;
            objectCSS.position.y = Math.random() * 4000 - 2000;
            objectCSS.position.z = Math.random() * 4000 - 2000;
            scene.add(objectCSS);

            objects.push(objectCSS);

            // Target for table layout
            const object = new THREE.Object3D();
            object.position.x = (data[i][3] * 140) - 1330; // Adjust x position based on column 4 in Google Sheet
            object.position.y = -(data[i][4] * 180) + 990; // Adjust y position based on column 5 in Google Sheet

            targets.table.push(object);
        }
    }

    function transform(targets, duration) {
        TWEEN.removeAll();

        for (let i = 0; i < objects.length; i++) {
            const object = objects[i];
            const target = targets[i];

            new TWEEN.Tween(object.position)
                .to({ x: target.position.x, y: target.position.y, z: target.position.z }, Math.random() * duration + duration)
                .easing(TWEEN.Easing.Exponential.InOut)
                .start();

            new TWEEN.Tween(object.rotation)
                .to({ x: target.rotation.x, y: target.rotation.y, z: target.rotation.z }, Math.random() * duration + duration)
                .easing(TWEEN.Easing.Exponential.InOut)
                .start();
        }

        new TWEEN.Tween(this)
            .to({}, duration * 2)
            .onUpdate(render)
            .start();
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
        render();
    }

    function animate() {
        requestAnimationFrame(animate);
        TWEEN.update();
        controls.update();
    }

    function render() {
        renderer.render(scene, camera);
    }
</script>

</body>
</html>
